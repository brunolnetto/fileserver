{% extends 'web/base.html' %}

{% block title %}Cadastro{% endblock %}

{% block content %}
<h1>Cadastro</h1>
<form method="post" id="signup-form" class="form-container">
    {% csrf_token %}
    
    <!-- Username Field -->
    <div class="form-group">
        <label for="username">Usuário:</label>
        <div class="input-group">
            <input 
                type="text" 
                id="username" 
                name="username" 
                class="form-control form-control-sm" 
                placeholder="Insira usuário" 
                required            
                onfocus="clearPlaceholder(this)" 
                onblur="restorePlaceholder(this)"
            >
            <div class="input-group-append">
                <span id="username-icon" class="input-group-text">
                    <i id="username-icon-element" class="bi"></i>
                </span>
            </div>
        </div>
        <div id="username-feedback" class="feedback text-danger"></div>
        <div id="username-loading" class="loading-text"></div>
    </div>

    <!-- Email Field -->
    <div class="form-group">
        <label for="email">E-mail:</label>
        <div class="input-group">
            <input 
                type="email" 
                id="email" 
                name="email" 
                class="form-control form-control-sm" 
                placeholder="Insira e-mail" 
                required
                onfocus="clearPlaceholder(this)" 
                onblur="restorePlaceholder(this)"
            >
            <div class="input-group-append">
                <span id="email-icon" class="input-group-text">
                    <i id="email-icon-element" class="bi"></i>
                </span>
            </div>
        </div>
        <div id="email-feedback" class="feedback text-danger"></div>
        <div id="email-loading" class="loading-text"></div>
    </div>

    <!-- Password Field -->
    <div class="form-group">
        <label for="password1">Senha:</label>
        <div class="password-container">
            <input 
                type="password" 
                id="password1" 
                name="password1" 
                class="form-control form-control-sm" 
                placeholder="Insira senha" 
                required
                onfocus="clearPlaceholder(this)" 
                onblur="restorePlaceholder(this)"
            >
            <button type="button" id="togglePassword1" class="toggle-password">
                <i class="bi bi-eye-slash"></i>
            </button>
        </div>
    </div>

    <!-- Confirm Password Field -->
    <div class="form-group">
        <label for="password2">Confirmar senha:</label>
        <div class="password-container">
            <input 
                type="password" 
                id="password2" 
                name="password2" 
                class="form-control form-control-sm" 
                placeholder="Confirme senha" 
                required
                onfocus="clearPlaceholder(this)" 
                onblur="restorePlaceholder(this)"
            >
            <button type="button" id="togglePassword2" class="toggle-password">
                <i class="bi bi-eye-slash"></i>
            </button>
        </div>
    </div>

    <button type="submit" class="btn btn-primary">Cadastrar</button>

    <!-- Validation messages -->
    <div id="validation-messages" style="margin-top: 10px;"></div>
</form>

<script>
    let usernameDelayTimer;
    let emailDelayTimer;
    let validationMessages = document.getElementById('validation-messages');
    const signupButton = document.querySelector('#signup-form button[type="submit"]');

    // Function to clear placeholder on focus
    function clearPlaceholder(element) {
        element.setAttribute('data-placeholder', element.placeholder); // Save current placeholder
        element.placeholder = ''; // Clear placeholder
    }

    // Function to restore placeholder on blur
    function restorePlaceholder(element) {
        if (!element.value) { // Restore only if input is empty
            element.placeholder = element.getAttribute('data-placeholder');
        }
    }

    // Toggle password visibility
    function togglePasswordVisibility(toggleButtonId, passwordFieldId) {
        document.getElementById(toggleButtonId).addEventListener('click', function() {
            var passwordField = document.getElementById(passwordFieldId);
            var type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordField.setAttribute('type', type);

            var icon = this.querySelector('i');
            icon.classList.toggle('bi-eye-slash', type === 'password');
            icon.classList.toggle('bi-eye', type === 'text');
        });
    }

    togglePasswordVisibility('togglePassword1', 'password1');
    togglePasswordVisibility('togglePassword2', 'password2');

    // Validate username
    function validateUsername(username) {
        return /^[a-zA-Z0-9_-]{5,20}$/.test(username);
    }

    // Validate email
    function validateEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function addValidationMessage(message) {
        const listItem = document.createElement('li');
        listItem.textContent = message;
        validationMessages.appendChild(listItem);
    }

    function clearValidationMessages() {
        validationMessages.innerHTML = ''; // Clear all messages
    }

    function enableSignupButton() {
        signupButton.disabled = false;
    }

    function disableSignupButton() {
        signupButton.disabled = true;
    }

    // Check availability of username or email
    function checkAvailability(type, value, feedbackElement, loadingElement, iconElement) {
        clearTimeout(type === 'username' ? usernameDelayTimer : emailDelayTimer);

        if (value) {
            const delayTimer = setTimeout(() => {
                fetch(`/check-${type}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value
                    },
                    body: JSON.stringify({ [type]: value })
                })
                .then(response => {
                    // Log the response status
                    console.log(`Response Status for ${type}:`, response.status); 
                    return response.json();
                })
                .then(data => {
                    // Log the response data
                    console.log(`Response Data for ${type}:`, data); 
                    const isAvailable = !data.exists;
                    displayAvailability(type, isAvailable, feedbackElement, loadingElement, iconElement);
                })
                .catch((error) => {
                    // Log fetch errors
                    console.error(`Fetch Error for ${type}:`, error);
                    displayAvailability(type, false, feedbackElement, loadingElement, iconElement, 'Erro ao checar disponibilidade.');
                });
            }, 250);

            if (type === 'username') {
                usernameDelayTimer = delayTimer;
            } else {
                emailDelayTimer = delayTimer;
            }
        } else {
            loadingElement.textContent = '';
            feedbackElement.textContent = '';
            iconElement.className = 'bi'; // Reset icon
        }
    }

    // Display availability status
    function displayAvailability(type, isAvailable, feedbackElement, iconElement, errorMessage) {
        feedbackElement.textContent = '';
        if (errorMessage) {
            addValidationMessage(errorMessage)
            iconElement.className = 'bi bi-x-circle'; // Error icon
        } else if (isAvailable) {
            iconElement.className = 'bi bi-check-circle'; // Check icon
        } else {
            addValidationMessage(`${type === 'username' ? 'Usuário' : 'E-mail'} já existe.`);
            iconElement.className = 'bi bi-x-circle'; // Error icon
        }
    }

    // Validate the form fields and enable/disable the signup button
    function validateForm() {
        const username = document.getElementById('username').value.trim();
        const email = document.getElementById('email').value.trim();
        const password1 = document.getElementById('password1').value;
        const password2 = document.getElementById('password2').value;

        let valid = true;

        // Check username
        if (validateUsername(username)) {
            if (document.getElementById('username-feedback').textContent.includes('já existe') ||
                document.getElementById('username-feedback').textContent.includes('inválido')) {
                valid = false;
            }
        } else {
            valid = false;
        }

        // Check email
        if (validateEmail(email)) {
            if (document.getElementById('email-feedback').textContent.includes('inválido') ||
                document.getElementById('email-feedback').textContent.includes('já existe')) {
                valid = false;
            }
        } else {
            valid = false;
        }

        // Check if passwords match
        if (password1 !== password2) {
            addValidationMessage('Senhas não coincidem.');
            valid = false;
        }

        if (valid) {
            enableSignupButton();
        } else {
            disableSignupButton();
        }
    }

    // Initialize event listeners
    document.addEventListener('DOMContentLoaded', () => {
        const usernameInput = document.getElementById('username');
        const usernameFeedback = document.getElementById('username-feedback');
        const usernameLoading = document.getElementById('username-loading');
        const usernameIcon = document.getElementById('username-icon-element');

        const emailInput = document.getElementById('email');
        const emailFeedback = document.getElementById('email-feedback');
        const emailLoading = document.getElementById('email-loading');
        const emailIcon = document.getElementById('email-icon-element');

        // Disable signup button initially
        disableSignupButton();

        usernameInput.addEventListener('input', function() {
            const username = this.value.trim();
            clearValidationMessages(); // Clear previous messages
            if (validateUsername(username)) {
                checkAvailability('username', username, usernameIcon);
            } else {
                addValidationMessage('Nome de usuário inválido. Deve ter 5-20 caracteres e pode conter letras, números, underscores e hífens.');
                usernameIcon.className = 'bi bi-x-circle'; // Error icon
                validateForm();
            }
        });

        emailInput.addEventListener('input', function() {
            const email = this.value.trim();
            clearValidationMessages(); // Clear previous messages
            if (validateEmail(email)) {
                checkAvailability('email', email, emailIcon);
            } else {
                addValidationMessage('E-mail inválido.');
                emailIcon.className = 'bi bi-x-circle'; // Error icon
                validateForm();
            }
        });

        document.getElementById('signup-form').addEventListener('submit', function(event) {
            var username = document.getElementById('username').value;
            var email = document.getElementById('email').value;
            var password1 = document.getElementById('password1').value;
            var password2 = document.getElementById('password2').value;
            var valid = true;

            // Check if passwords match
            if (password1 !== password2) {
                addValidationMessage('Senhas não coincidem.');
                valid = false;
            }

            // Check username and email errors
            const usernameError = document.getElementById('username-feedback').textContent;
            const emailError = document.getElementById('email-feedback').textContent;

            if (usernameError.includes('já existe') || usernameError.includes('inválido')) {
                addValidationMessage(usernameError);
                valid = false;
            }

            if (emailError.includes('inválido') || emailError.includes('já existe')) {
                addValidationMessage(emailError);
                valid = false;
            }

            // Prevent form submission if there are validation errors
            if (!valid) {
                event.preventDefault();
            }
        });
    });
</script>

<style>
    .password-container {
        position: relative;
    }

    .toggle-password {
        position: absolute;
        right: 10px; /* Adjust as needed */
        top: 50%;
        transform: translateY(-50%);
        border: none;
        background: transparent;
        cursor: pointer;
        padding: 0;
        z-index: 2; /* Ensures the button is above other elements */
        outline: none; /* Remove outline on focus */
    }

    .toggle-password i {
        font-size: 1.5em; /* Increased icon size */
        color: #007bff; /* Primary color for visibility */
        transition: color 0.3s ease; /* Smooth transition for color change */
    }

    .toggle-password:hover i {
        color: #0056b3; /* Lighter shade for hover effect */
    }

    .form-control {
        padding-right: 3em; /* Adjust padding to make room for the icon */
    }

    .toggle-password:focus, .toggle-password:active {
        outline: none; /* Remove default focus outline */
        box-shadow: none; /* Remove focus box-shadow if any */
    }

    .feedback {
        font-size: 0.875em;
    }

    .form-group {
        position: relative;
    }
    
    .input-group {
        display: flex;
        align-items: center;
        position: relative;
    }

    .input-group-append {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .input-group-text {
        width: 2.5em; /* Fixed width for consistency */
        height: 100%;
        display: flex;
        background: transparent;
        border: none;
        align-items: center;
        justify-content: center;
        min-width: 2.5em; /* Ensures the container maintains space even when empty */
    }

    .icon-placeholder {
        display: inline-block;
        width: 2em; /* Adjust width to provide space for the icon */
        height: 1.5em; /* Adjust height as needed */
    }

    .input-group-text.bi {
        font-size: 1.25em;
    }

    .feedback, .loading-text {
        position: absolute;
        bottom: -1.5em; /* Adjust to be close to the input field */
        left: 0;
        width: 100%;
        font-size: 0.875em; /* Smaller text for feedback */
    }
    
    .feedback {
        margin-top: 0.25em; /* Space between input field and feedback */
        font-size: 0.875em; /* Slightly smaller font size for feedback */
    }
    
    .feedback.text-success {
        color: #28a745; /* Green for available */
    }
    
    .feedback.text-danger {
        color: #dc3545; /* Red for not available */
    }
    
    
    .loading-text {
        color: #6c757d; /* Gray for loading state */
        font-size: 0.875em; /* Smaller text for loading */
    }
</style>
    
{% endblock %}
